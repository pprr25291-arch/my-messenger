<!DOCTYPE html>
<html>
<head>
    <title>Anonimo - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="/style.css">
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ JavaScript
        window.USERNAME = '<%= username %>';
        window.USER_TOKEN = '<%= token %>';
    </script>
</head>
<body>
    <div class="chat-container">
        <header>
            <h2>Anonimo</h2>
            <div class="header-content">
                <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username"><%= username %></span>!</span>
                <div class="header-buttons">
                    <button id="notificationsBtn" class="header-btn" type="button">üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                    <button id="privateBtn" class="header-btn active" type="button">üí¨ –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</button>
                    <% if (username === 'admin') { %>
                    <button id="adminBtn" class="header-btn" type="button">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
                    <% } %>
                    <button class="header-btn" type="button" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>
        
        <div class="chat-content">
            <!-- –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <div id="notificationsPanel" class="chat-section" style="display: none;">
                <div class="notifications-header">
                    <h3>üì¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <p>–í–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã</p>
                </div>
                <div id="notifications" class="notifications-list">
                    <div class="no-notifications">
                        <div class="no-notifications-icon">üìã</div>
                        <h3>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
                        <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç -->
            <div id="privateChat" class="chat-section">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω JavaScript -->
                <div class="loading-chat">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/chat.js"></script>
    <script src="/private-chat.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => window.location.href = '/')
                .catch(() => window.location.href = '/');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting application initialization...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
            setTimeout(() => {
                if (!window.privateChatInstance) {
                    console.log('üîÑ Creating PrivateChat instance...');
                    window.privateChatInstance = new PrivateChat();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                    setTimeout(() => {
                        if (window.privateChatInstance && window.privateChatInstance.isInitialized) {
                            console.log('‚úÖ PrivateChat instance created successfully');
                        } else {
                            console.error('‚ùå Failed to create PrivateChat instance');
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                            showFallbackChatInterface();
                        }
                    }, 2000);
                }
            }, 100);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            const username = document.getElementById('username')?.textContent;
            if (username === 'admin') {
                const adminBtn = document.getElementById('adminBtn');
                if (adminBtn) {
                    adminBtn.addEventListener('click', () => {
                        if (window.privateChatInstance && typeof window.privateChatInstance.toggleAdminPanel === 'function') {
                            window.privateChatInstance.toggleAdminPanel();
                        } else {
                            console.error('Admin panel method not available');
                            // Fallback –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                            showFallbackAdminPanel();
                        }
                    });
                }
            }
        });

        // Fallback —Ñ—É–Ω–∫—Ü–∏–∏
        function showFallbackChatInterface() {
            const privateChat = document.getElementById('privateChat');
            if (privateChat) {
                privateChat.innerHTML = `
                    <div class="fallback-chat">
                        <div class="fallback-header">
                            <h3>üí¨ –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                            <p>–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
                        </div>
                        <div class="fallback-content">
                            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                            <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        </div>
                    </div>
                `;
            }
        }

        function showFallbackAdminPanel() {
            const adminPanel = document.createElement('div');
            adminPanel.id = 'fallbackAdminPanel';
            adminPanel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                width: 90%;
            `;
            
            adminPanel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
                </div>
                <p>–û—Å–Ω–æ–≤–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                <button onclick="location.reload()" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            `;
            
            document.body.appendChild(adminPanel);
        }
    </script>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div id="voiceRecordModal" class="modal-overlay" style="display: none;">
    <div class="modal-content voice-recording-panel">
        <div class="modal-header">
            <h4>üé§ –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</h4>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="recording-status">
                <div id="recordingTimer">00:00</div>
                <div id="recordingStatus">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏...</div>
            </div>
            
            <div class="voice-visualization">
                <canvas id="voiceVisualization" width="400" height="80"></canvas>
            </div>
            
            <div class="recording-controls">
                <button id="startRecordingBtn" class="btn btn-success">
                    üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                </button>
                <button id="stopRecordingBtn" class="btn btn-danger" disabled>
                    ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
                <button id="playRecordingBtn" class="btn btn-info" disabled>
                    ‚ñ∂Ô∏è –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                </button>
                <button id="sendVoiceBtn" class="btn btn-primary" disabled>
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
                <button id="cancelRecordingBtn" class="btn btn-warning">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
            
            <div class="recording-info">
                <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5 –º–∏–Ω—É—Ç</p>
                <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —Å–µ–∫—É–Ω–¥–∞</p>
            </div>
        </div>
    </div>
</div>

       
</div>

</body>
</html>
